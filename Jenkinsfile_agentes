pipeline {
    agent any

    environment {
        AWS_REGION = 'us-east-1'
        STACK_NAME = 'todo-list-aws-staging'
        SAM_CONFIG_FILE = 'samconfig.toml'
        SAM_CONFIG_ENV = 'staging'
        PATH = "/var/lib/jenkins/.local/bin:${env.PATH}"
    }

    stages {
        stage('Get Code') {
            agent { label 'agent2' }
            steps {
                script {
                    sh '''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                    '''
                    checkout([$class: 'GitSCM', branches: [[name: '*/develop']], userRemoteConfigs: [[url: 'https://github.com/JGilPantoja/todolist-aws.git']]])
                }
            }
        }

        stage('Static Test') {
            parallel {
                stage('Flake8') {
                    agent { label 'agent1' }
                    steps {
                        script {
                            sh '''
                                whoami
                                hostname
                                echo ${WORKSPACE}
                                flake8 src --exit-zero --format=pylint > flake8_report.txt || true
                            '''
                            archiveArtifacts artifacts: 'flake8_report.txt', fingerprint: true
                        }
                    }
                }

                stage('Bandit') {
                    agent { label 'agent1' }
                    steps {
                        script {
                            sh '''
                                whoami
                                hostname
                                echo ${WORKSPACE}
                                bandit -r src -f txt -o bandit_report.txt || true
                            '''
                            archiveArtifacts artifacts: 'bandit_report.txt', fingerprint: true
                        }
                    }
                }
            }
        }

                stage('Deploy') {
            agent any
            steps {
                script {
                    sh '''
                        whoami
                        hostname
                        echo ${WORKSPACE}
                        
                        sam build --config-file $SAM_CONFIG_FILE --config-env $SAM_CONFIG_ENV --region $AWS_REGION
            
                        sam validate --config-file $SAM_CONFIG_FILE --config-env $SAM_CONFIG_ENV --region $AWS_REGION
                        
                        sam deploy --config-file $SAM_CONFIG_FILE \
                                   --config-env $SAM_CONFIG_ENV \
                                   --region $AWS_REGION \
                                   --no-confirm-changeset \
                                   --capabilities CAPABILITY_IAM || \
                                   if [ $? -eq 1 ]; then echo "No changes to deploy, continuing..."; else exit 1; fi
                        
                        # Guardar URL en archivo para que la etapa Rest Test pueda usarla
                        export BASE_URL=$(aws cloudformation describe-stacks \
                            --stack-name $STACK_NAME --query "Stacks[0].Outputs[?OutputKey=='BaseUrlApi'].OutputValue" --output text)
                        echo $BASE_URL > ${WORKSPACE}/base_url.txt
                    '''
                }
            }
        }


        stage('Rest Test') {
            agent { label 'agent2' }
            steps {
                script {
                    sh '''
                        whoami
                        hostname
                        echo ${WORKSPACE}

                        # Verificar que pytest esté instalado, si no, instalarlo
                        if ! command -v pytest &> /dev/null; then
                            echo "pytest no encontrado, instalándolo..."
                            pip3 install --user pytest
                        fi

                        # Verificar que el archivo existe antes de leerlo
                        if [ -f ${WORKSPACE}/base_url.txt ]; then
                            export BASE_URL=$(cat ${WORKSPACE}/base_url.txt)
                            echo "Base URL: $BASE_URL"
                        else
                            echo "Error: No se encontró base_url.txt"
                            exit 1
                        fi

                        pytest --maxfail=1 --disable-warnings test/integration/todoApiTest.py
                    '''
                }
            }
        }



        stage('Promote') {
            agent any 
            steps {
                withCredentials([string(credentialsId: 'GITHUB_TOKEN', variable: 'TOKEN')]) {
                    script {
                        sh '''
                            git config user.email "jenkins@jenkins.com"
                            git config user.name "Jenkins"
                            git fetch origin
                            git checkout master
                            git checkout develop || git checkout -b develop origin/develop
                            git checkout master
                            echo "Promoted to production at $(date)" >> README.md
                            git add README.md
                            git commit -m "Promoted to production on $(date)"
                            git merge develop
                            git push https://$TOKEN@github.com/JGilPantoja/todolist-aws.git master
                        '''
                    }
                }
            }
        }
    }
}
